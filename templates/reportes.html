<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Generados</title>
    <link rel="stylesheet" href="/static/css/reportes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="barra-superior">
            <div class="home-icon" title="Inicio" onclick="window.location.href='/dashboard'">
                <i class="fas fa-home"></i>
            </div>
            <h1 class="titulo">REPORTES GENERADOS</h1>
            <div class="fas- fas-user-tie">○</div>
        </div>
    </header>

    <main class="reportes-container">
        <div class="panel-contenido">
            <div class="lista-reportes">
                <div class="reporte-header">
                    <h3><i class="fas fa-file-alt"></i> Listado de Reportes</h3>
                    <button class="btn-nuevo" onclick="window.location.href='/proyectos'">
                        <i class="fas fa-plus"></i> Generar Nuevo
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Proyecto</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reporte in reportes %}
                            <tr>
                                <td>{{ reporte.id }}</td>
                                <td>{{ reporte.proyecto_nombre }}</td>
                                <td>{{ reporte.tipo|upper }}</td>
                                <td>{{ reporte.fecha_generacion }}</td>
                                <td class="acciones">
                                    <a href="/{{ reporte.ruta_archivo }}" download class="btn-descargar">
                                        <i class="fas fa-download"></i> Descargar
                                    </a>
                                    <a href="/{{ reporte.ruta_archivo }}" target="_blank" class="btn-ver">
                                        <i class="fas fa-eye"></i> Ver
                                    </a>
                                    <button class="btn-eliminar" onclick="eliminarReporte('{{ reporte.id }}')">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="no-data">No hay reportes generados aún</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
    function eliminarReporte(reporteId) {
        if (confirm('¿Estás seguro de eliminar este reporte?')) {
            fetch(`/eliminar-reporte/${reporteId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Reporte eliminado correctamente');
                    window.location.reload();
                } else {
                    alert('Error al eliminar: ' + data.error);
                }
            });
        }
    }
    document.getElementById('generar-reporte').addEventListener('click', async function() {
    if (!proyectoActual) {
        alert('Por favor selecciona un proyecto primero');
        return;
    }

    const btn = this;
    const originalText = btn.innerHTML;
    
    try {
        // Mostrar carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
        btn.disabled = true;

        const response = await fetch(`/generar-reporte/${proyectoActual}`);
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Error desconocido');
        }

        // Descargar el archivo
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_${proyectoActual}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Error al generar reporte:', error);
        alert(`Error al generar reporte: ${error.message}`);
    } finally {
        // Restaurar botón
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
    </script>
</body>
</html>